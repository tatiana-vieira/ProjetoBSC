{% extends 'basepro.html' %}

{% block titulo %}
    Cadastro de Meta - PRPPG
{% endblock %}

{% block conteudo %}
<div class="card" style="max-width: 1000px; margin: 0 auto;">
    <div class="card-header" style="background-color: #054b91;">
        <h4 style="text-align: center; color: #ffffff;">Cadastro de Meta</h4>
    </div>
    <div class="card-body">
        <form id="MetaForm" method="POST" action="{{ url_for('cadastro_meta') }}">
            <div class="form-group">
                <label for="pdi_id">PDI:</label>
                <select id="pdi_id" name="pdi_id" required class="form-control">
                    {% for pdi in lista_pdis %}
                        <option value="{{ pdi.id }}">{{ pdi.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="objetivo_id">Objetivo:</label>
                <select id="objetivo_id" name="objetivo_id" required class="form-control">
                    <!-- Opções de objetivo carregadas dinamicamente -->
                </select>
            </div>

            <div class="form-group">
                <label for="nome">Nome da Meta:</label>
                <input type="text" id="nome" name="nome" required class="form-control">
            </div>

            <div class="form-group">
                <label for="porcentagem_execucao">Porcentagem de Execução:</label>
                <input type="number" id="porcentagem_execucao" name="porcentagem_execucao" required class="form-control">
            </div>

            <div style="text-align: center;">
                <button type="submit" style="background-color: darkblue; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cadastrar</button>
                <button type="button" onclick="window.history.back()" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Cancelar</button>
                <button type="button" onclick="fechar()" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Fechar</button><br>

            </div>
        </form>
        <script>
            function fechar() {
                window.location.href = "{{ url_for('login.get_proreitor') }}";
            }
        </script>
    </div>
</div>

<!-- Tabela para listar as metas cadastradas -->
<div class="card mt-4" style="max-width: 1000px; margin: 0 auto;">
    <div class="card-header" style="background-color: #054b91;">
        <h4 style="text-align: center; color: #ffffff;">Metas Cadastradas</h4>
    </div>
    <div class="card-body">
        <table class="table table-bordered" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 30%;">Nome da Meta</th>
                    <th style="width: 25%;">Objetivo</th>
                    <th style="width: 15%;">Porcentagem de Execução</th>
                    <th style="width: 20%;">Última Atualização</th>
                    <th style="width: 10%;">Ações</th>
                </tr>
            </thead>
            <tbody id="meta-list">
                {% for meta in metas %}
                    <tr>
                        <td>{{ meta.nome }}</td>
                        <td>{{ meta.objetivo.nome }}</td>
                        <td>{{ meta.porcentagem_execucao }}%</td>
                        <td>{{ meta.data_ultima_atualizacao.strftime('%d/%m/%Y') if meta.data_ultima_atualizacao else 'N/A' }}</td>
                        <td>
                            <!-- Botão "Alterar" em verde -->
                            <a href="{{ url_for('editar_meta', meta_id=meta.id) }}" class="btn btn-success btn-sm">Alterar</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function cancelar() {
        window.location.href = "{{ url_for('cadastro_meta') }}";
    }

    document.getElementById('pdi_id').addEventListener('change', function() {
        const pdiId = this.value;
        fetch(`/objetivos_relacionados_pdi/${pdiId}`)
            .then(response => response.json())
            .then(data => {
                const objetivoSelect = document.getElementById('objetivo_id');
                objetivoSelect.innerHTML = '';

                data.forEach(objetivo => {
                    const option = document.createElement('option');
                    option.value = objetivo.id;
                    option.text = objetivo.nome;
                    objetivoSelect.appendChild(option);
                });

                // Atualiza a lista de metas para o PDI selecionado
                atualizarMetas(pdiId);
            });
    });

    function atualizarMetas(pdiId) {
    fetch(`/metas_relacionadas_pdi/${pdiId}`)
        .then(response => response.json())
        .then(data => {
            const metaList = document.getElementById('meta-list');
            metaList.innerHTML = ''; // Limpa as metas atuais na tabela

            data.forEach(meta => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${meta.nome}</td>
                    <td>${meta.objetivo_nome}</td>
                    <td>${meta.porcentagem_execucao}%</td>
                    <td>${meta.data_ultima_atualizacao ? meta.data_ultima_atualizacao : 'N/A'}</td>
                    <td><a href="/editar_meta/${meta.id}" class="btn btn-success btn-sm">Alterar</a></td>
                `;
                metaList.appendChild(row);
            });
        });
}

    window.onload = function() {
        const pdiId = document.getElementById('pdi_id').value;
        if (pdiId) {
            fetch(`/objetivos_relacionados_pdi/${pdiId}`)
                .then(response => response.json())
                .then(data => {
                    const objetivoSelect = document.getElementById('objetivo_id');
                    objetivoSelect.innerHTML = '';

                    data.forEach(objetivo => {
                        const option = document.createElement('option');
                        option.value = objetivo.id;
                        option.text = objetivo.nome;
                        objetivoSelect.appendChild(option);
                    });

                    // Carrega as metas do PDI selecionado ao carregar a página
                    atualizarMetas(pdiId);
                });
        }
    }
    row.innerHTML = `
    <td>${meta.nome}</td>
    <td>${meta.objetivo_nome}</td>
    <td>${meta.porcentagem_execucao}%</td>
    <td>${meta.data_ultima_atualizacao ? meta.data_ultima_atualizacao : 'N/A'}</td>
    <td><a href="/editar_meta/${meta.id}" class="btn btn-success btn-sm">Alterar</a></td>
`;
</script>
{% endblock %}
