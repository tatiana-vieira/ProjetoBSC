{% extends 'base.html' %}

{% block titulo %}
    <h2 style="color: #003366;">ALTERAR META</h2>
{% endblock %}

{% block conteudo %}
<div style="margin: auto; width: 50%; text-align: center;">
    <div class="form-block"><br>
        {% if success_message %}
            <div style="color: green; margin-bottom: 20px;">{{ success_message }}</div>
        {% endif %}
        <form id="MetaForm" method="POST" action="{{ url_for('alterar_meta') }}">
            <label for="pdi_id">PDI:</label>
            <select id="pdi_id" name="pdi_id" required style="width: 100%; margin-bottom: 10px;" onchange="fetchObjetivos()">
                <option value="">Selecione um PDI</option>
                {% for pdi in lista_pdis %}
                    <option value="{{ pdi.id }}" {% if meta and pdi.id == meta.objetivo.pdi_id %}selected{% endif %}>{{ pdi.nome }}</option>
                {% endfor %}
            </select><br>

            <label for="objetivo_id">Objetivo:</label>
            <select id="objetivo_id" name="objetivo_id" required style="width: 100%; margin-bottom: 10px;" onchange="fetchMeta()">
                <option value="">Selecione um objetivo</option>
                {% for objetivo in objetivos %}
                    <option value="{{ objetivo.id }}" {% if meta and objetivo.id == meta.objetivo_id %}selected{% endif %}>{{ objetivo.nome }}</option>
                {% endfor %}
            </select><br>

            {% if meta %}
            <input type="hidden" name="meta_id" value="{{ meta.id }}">
            <label for="nome">Nome da Meta:</label>
            <input type="text" id="nome" name="nome" value="{{ meta.nome }}" required style="width: 100%; margin-bottom: 10px;"><br>
            <label for="porcentagem_execucao">Porcentagem de Execução:</label>
            <input type="number" id="porcentagem_execucao" name="porcentagem_execucao" value="{{ meta.porcentagem_execucao }}" required style="width: 100%; margin-bottom: 10px;"><br>

            <button type="submit" style="background-color: darkblue; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Salvar Alterações</button>
            <button type="button" onclick="fechar()" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Fechar</button><br>
            {% endif %}
        </form>
        <script>
            function fetchObjetivos() {
                var pdiId = document.getElementById('pdi_id').value;
                if (pdiId) {
                    fetch('/objetivos_relacionados_pdi/' + pdiId)
                        .then(response => response.json())
                        .then(data => {
                            var selectObjetivos = document.getElementById('objetivo_id');
                            selectObjetivos.innerHTML = '<option value="">Selecione um objetivo</option>';
                            data.forEach(objetivo => {
                                var option = document.createElement('option');
                                option.value = objetivo.id;
                                option.text = objetivo.nome;
                                selectObjetivos.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Erro ao buscar objetivos:', error));
                }
            }

            function fetchMeta() {
                var objetivoId = document.getElementById('objetivo_id').value;
                if (objetivoId) {
                    window.location.href = "{{ url_for('alterar_meta') }}?objetivo_id=" + objetivoId + "&pdi_id=" + document.getElementById('pdi_id').value;
                }
            }

            function fechar() {
                window.location.href = "{{ url_for('login.get_proreitor') }}";
            }
        </script>
    </div>
</div>
{% endblock %}